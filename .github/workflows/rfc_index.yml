name: RFC Index Generator

on:
  push:
    paths:
      - "specs/**"
      - "rejected/**"
      - "rfcs/**"
  workflow_dispatch: {}

permissions:
  contents: write

jobs:
  index:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Ensure folders
        run: |
          mkdir -p rfcs specs rejected

      - name: Install yq (YAML CLI)
        run: |
          sudo wget -q https://github.com/mikefarah/yq/releases/download/v4.44.3/yq_linux_amd64 -O /usr/local/bin/yq
          sudo chmod +x /usr/local/bin/yq
          yq --version

      - name: Generate RFC Index (Draft / Accepted / Rejected)
        id: gen
        shell: bash
        run: |
          set -euo pipefail

          build_table () {
            local root="$1"
            echo "| ID | Title | Authors | Status |"
            echo "|----|-------|---------|--------|"

            # find .md files named rfc.md under the root (ignore if none)
            while IFS= read -r -d '' file; do
              # Frontmatter fields (fall back to sensible defaults)
              ID=$(yq '.id // ""' "$file" | tr -d '"')
              TITLE=$(yq '.title // ""' "$file" | sed 's/^"//;s/"$//')
              STATUS=$(yq '.status // "Draft"' "$file" | tr -d '"')
              # Join authors array with spaces (or blank)
              AUTHORS=$(yq -o=tsv '.authors // [] | .[]' "$file" 2>/dev/null | paste -sd' ' - || true)

              # make relative link
              RELATIVE="./${file}"
              echo "| [$ID]($RELATIVE) | $TITLE | $AUTHORS | $STATUS |"
            done < <(find "$root" -type f -name rfc.md -print0 2>/dev/null | sort -z)
          }

          {
            echo "# RFC Index"
            echo
            echo "## Draft RFCs"
            build_table "rfcs"
            echo
            echo "## Accepted RFCs"
            build_table "specs"
            echo
            echo "## Rejected RFCs"
            build_table "rejected"
          } > RFC_INDEX.md

      - name: Commit updated index
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add RFC_INDEX.md
          git commit -m "Update RFC index" || echo "No changes to commit"
          git push
