name: RFC Index Generator

on:
  workflow_run:
    workflows: ["RFC Finalize"]   # â† only after finalize completes
    types: [completed]
  workflow_dispatch: {}

permissions:
  contents: write

concurrency:
  group: rfc-index
  cancel-in-progress: false
    
jobs:
  index:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Ensure folders
        run: |
          mkdir -p rfcs specs rejected

      - name: Install yq
        run: |
          sudo wget -q https://github.com/mikefarah/yq/releases/download/v4.44.3/yq_linux_amd64 -O /usr/local/bin/yq
          sudo chmod +x /usr/local/bin/yq

      - name: Count content
        id: scan
        shell: bash
        run: |
          set -euo pipefail
          count() { find "$1" -type f -name 'rfc.md' 2>/dev/null | wc -l | awk '{print $1}'; }
          echo "drafts=$(count rfcs)"     >> "$GITHUB_OUTPUT"
          echo "accepted=$(count specs)"  >> "$GITHUB_OUTPUT"
          echo "rejected=$(count rejected)" >> "$GITHUB_OUTPUT"

      - name: Generate RFC Index (Draft / Accepted / Rejected)
        shell: bash
        run: |
          set -euo pipefail
          build_table () {
            local root="$1"
            echo "| ID | Title | Authors | Status |"
            echo "|----|-------|---------|--------|"
            while IFS= read -r -d '' file; do
              ID=$(yq eval --front-matter=extract '.id // ""' "$file" | tr -d '"')
              TITLE=$(yq eval --front-matter=extract '.title // ""' "$file" | sed 's/^"//;s/"$//')
              STATUS=$(yq eval --front-matter=extract '.status // "Draft"' "$file" | tr -d '"')
              AUTHORS=$(yq eval --front-matter=extract -o=tsv '.authors // [] | .[]' "$file" 2>/dev/null | paste -sd' ' - || true)
              echo "| [$ID](./${file}) | $TITLE | $AUTHORS | $STATUS |"
            done < <(find "$root" -type f -name rfc.md -print0 2>/dev/null | sort -z)
          }

          {
            echo "# RFC Index"
            echo
            echo "## Draft RFCs"
            if [ "${{ steps.scan.outputs.drafts }}" = "0" ]; then echo "_None yet_"; else build_table "rfcs"; fi
            echo
            echo "## Accepted RFCs"
            if [ "${{ steps.scan.outputs.accepted }}" = "0" ]; then echo "_None yet_"; else build_table "specs"; fi
            echo
            echo "## Rejected RFCs"
            if [ "${{ steps.scan.outputs.rejected }}" = "0" ]; then echo "_None yet_"; else build_table "rejected"; fi
          } > RFC_INDEX.md

      - name: Commit updated index
        shell: bash
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add RFC_INDEX.md
          git commit -m "Update RFC index" || echo "No changes"
          git pull --rebase origin "${GITHUB_REF_NAME:-main}" || true
          git push || true
